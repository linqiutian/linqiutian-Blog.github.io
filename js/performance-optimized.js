(function(){"use strict";function n(c,r,s){let a;return function e(...n){const t=this;const o=function(){a=null;if(!s)c.apply(t,n)};const i=s&&!a;clearTimeout(a);a=setTimeout(o,r);if(i)c.apply(t,n)}}function e(o,i){let c;let r;let s;return function e(...n){const t=this;if(!c){o.apply(t,n);s=Date.now();c=true}else{clearTimeout(r);r=setTimeout(function(){if(Date.now()-s>=i){o.apply(t,n);s=Date.now()}},i-(Date.now()-s))}}}function t(){if(!("IntersectionObserver"in window)){i();return}const e=document.querySelectorAll('img[data-src], img[loading="lazy"]');const n=new IntersectionObserver(function(e,t){e.forEach(function(e){if(e.isIntersecting){const n=e.target;o(n);t.unobserve(n)}})},{rootMargin:"50px 0px",threshold:.01});e.forEach(function(e){n.observe(e)})}function o(e){const n=e.dataset.src||e.src;if(n){e.src=n;e.removeAttribute("data-src")}if(!e.decoding){e.decoding="async"}e.addEventListener("load",function(){e.classList.add("loaded")},{once:true});e.addEventListener("error",function(){e.classList.add("error")},{once:true})}function i(){const e=document.querySelectorAll("img[data-src]");e.forEach(function(e){o(e)})}function c(){const e=document.querySelectorAll("img");e.forEach(function(e){if(!e.loading){e.loading="lazy"}if(!e.decoding){e.decoding="async"}})}function r(){let e=false;let n=0;const t=[];function o(){n=window.scrollY;t.forEach(function(e){try{e(n)}catch(e){console.warn("Scroll callback error:",e)}});e=false}function i(){if(!e){requestAnimationFrame(o);e=true}}window.addEventListener("scroll",i,{passive:true});window.registerScrollCallback=function(e){if(typeof e==="function"){t.push(e)}};window.getScrollY=function(){return n}}function s(){if(document.hidden){document.body.classList.add("page-hidden");window.dispatchEvent(new CustomEvent("page-hidden"))}else{document.body.classList.remove("page-hidden");window.dispatchEvent(new CustomEvent("page-visible"))}}function a(){const e=[{href:"/css/index.css",as:"style"},{href:"/js/main.js",as:"script"}];e.forEach(function(e){const n=document.querySelector('link[rel="preload"][href="'+e.href+'"]');if(n)return;const t=document.createElement("link");t.rel="preload";t.href=e.href;t.as=e.as;if(e.as==="style"){t.onload=function(){this.onload=null;this.rel="stylesheet"}}document.head.appendChild(t)})}function d(){const e=["s2.loli.net","i.loli.net","cdn.jsdelivr.net","www.fomal.cc"];e.forEach(function(e){const n=document.querySelector('link[rel="preconnect"][href*="'+e+'"]');if(n)return;const t=document.createElement("link");t.rel="preconnect";t.href="https://"+e;t.crossOrigin="anonymous";document.head.appendChild(t);const o=document.createElement("link");o.rel="dns-prefetch";o.href="https://"+e;document.head.appendChild(o)})}function l(){const e=document.querySelectorAll("script[data-defer]");e.forEach(function(e){const n=e.dataset.src;if(n){setTimeout(function(){const e=document.createElement("script");e.src=n;e.async=true;document.body.appendChild(e)},2e3)}})}function u(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function f(){document.documentElement.classList.add("reduced-motion");const e=document.querySelectorAll('[class*="animate"], .wow, .animated');e.forEach(function(e){e.style.animation="none";e.style.transition="none"});if(window.UniverseAnimation&&typeof window.UniverseAnimation.stop==="function"){window.UniverseAnimation.stop()}const n=document.querySelectorAll("#universe, canvas.animation");n.forEach(function(e){e.style.display="none"});const t=document.querySelectorAll("#waifu, #live2d-widget");t.forEach(function(e){e.style.display="none"});console.log("[Performance] 已禁用动画效果（用户偏好减少动画）")}function m(){document.documentElement.classList.remove("reduced-motion");const e=document.querySelectorAll('[class*="animate"], .wow, .animated');e.forEach(function(e){e.style.animation="";e.style.transition=""});if(window.UniverseAnimation&&typeof window.UniverseAnimation.start==="function"&&window.innerWidth>768){window.UniverseAnimation.start()}console.log("[Performance] 已恢复动画效果")}function w(){const e=window.matchMedia("(prefers-reduced-motion: reduce)");if(e.matches){f()}e.addEventListener("change",function(e){if(e.matches){f()}else{m()}})}function h(){const e=window.innerWidth<=768;a();c();t();r();l();document.addEventListener("visibilitychange",s);w();window.addEventListener("load",function(){setTimeout(function(){d()},2e3)});window.addEventListener("resize",n(function(){c()},250));console.log("[Performance] 性能优化脚本已加载");if(u()){console.log("[Performance] 检测到用户偏好减少动画")}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",h)}else{h()}window.PerformanceUtils={debounce:n,throttle:e,loadImage:o,prefersReducedMotion:u,disableAnimations:f,enableAnimations:m}})();